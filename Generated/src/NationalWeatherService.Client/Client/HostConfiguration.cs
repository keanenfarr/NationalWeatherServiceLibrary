/*
 * weather.gov API
 *
 * weather.gov API
 *
 * The version of the OpenAPI document: 2.6.0
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */

#nullable enable

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Net.Http;
using Microsoft.Extensions.DependencyInjection;
using NationalWeatherService.Client.Api;
using NationalWeatherService.Client.Model;

namespace NationalWeatherService.Client.Client
{
    /// <summary>
    /// Provides hosting configuration for NationalWeatherService.Client
    /// </summary>
    public class HostConfiguration
    {
        private readonly IServiceCollection _services;
        private readonly JsonSerializerOptions _jsonOptions = new JsonSerializerOptions();

        internal bool HttpClientsAdded { get; private set; }

        /// <summary>
        /// Instantiates the class 
        /// </summary>
        /// <param name="services"></param>
        public HostConfiguration(IServiceCollection services)
        {
            _services = services;
            _jsonOptions.Converters.Add(new JsonStringEnumConverter());
            _jsonOptions.Converters.Add(new DateTimeJsonConverter());
            _jsonOptions.Converters.Add(new DateTimeNullableJsonConverter());
            _jsonOptions.Converters.Add(new DateOnlyJsonConverter());
            _jsonOptions.Converters.Add(new DateOnlyNullableJsonConverter());
            _jsonOptions.Converters.Add(new AlertJsonConverter());
            _jsonOptions.Converters.Add(new AlertAtomEntryJsonConverter());
            _jsonOptions.Converters.Add(new AlertAtomEntryAuthorJsonConverter());
            _jsonOptions.Converters.Add(new AlertAtomFeedJsonConverter());
            _jsonOptions.Converters.Add(new AlertAtomFeedAuthorJsonConverter());
            _jsonOptions.Converters.Add(new AlertCertaintyJsonConverter());
            _jsonOptions.Converters.Add(new AlertCertaintyNullableJsonConverter());
            _jsonOptions.Converters.Add(new AlertCollectionJsonConverter());
            _jsonOptions.Converters.Add(new AlertCollectionGeoJsonJsonConverter());
            _jsonOptions.Converters.Add(new AlertCollectionGeoJsonAllOfFeaturesJsonConverter());
            _jsonOptions.Converters.Add(new AlertCollectionJsonLdJsonConverter());
            _jsonOptions.Converters.Add(new AlertGeoJsonJsonConverter());
            _jsonOptions.Converters.Add(new AlertGeocodeJsonConverter());
            _jsonOptions.Converters.Add(new AlertJsonLdJsonConverter());
            _jsonOptions.Converters.Add(new AlertMessageTypeJsonConverter());
            _jsonOptions.Converters.Add(new AlertMessageTypeNullableJsonConverter());
            _jsonOptions.Converters.Add(new AlertReferencesInnerJsonConverter());
            _jsonOptions.Converters.Add(new AlertSeverityJsonConverter());
            _jsonOptions.Converters.Add(new AlertSeverityNullableJsonConverter());
            _jsonOptions.Converters.Add(new AlertStatusJsonConverter());
            _jsonOptions.Converters.Add(new AlertStatusNullableJsonConverter());
            _jsonOptions.Converters.Add(new AlertUrgencyJsonConverter());
            _jsonOptions.Converters.Add(new AlertUrgencyNullableJsonConverter());
            _jsonOptions.Converters.Add(new AlertXMLParameterJsonConverter());
            _jsonOptions.Converters.Add(new AlertsActiveCount200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new AlertsTypes200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new AreaCodeJsonConverter());
            _jsonOptions.Converters.Add(new AreaCodeNullableJsonConverter());
            _jsonOptions.Converters.Add(new CenterWeatherAdvisoryJsonConverter());
            _jsonOptions.Converters.Add(new CenterWeatherAdvisoryCollectionGeoJsonJsonConverter());
            _jsonOptions.Converters.Add(new CenterWeatherAdvisoryCollectionGeoJsonAllOfFeaturesJsonConverter());
            _jsonOptions.Converters.Add(new CenterWeatherAdvisoryGeoJsonJsonConverter());
            _jsonOptions.Converters.Add(new GeoJSONLineStringJsonConverter());
            _jsonOptions.Converters.Add(new GeoJSONMultiLineStringJsonConverter());
            _jsonOptions.Converters.Add(new GeoJSONMultiPointJsonConverter());
            _jsonOptions.Converters.Add(new GeoJSONMultiPolygonJsonConverter());
            _jsonOptions.Converters.Add(new GeoJSONPointJsonConverter());
            _jsonOptions.Converters.Add(new GeoJSONPolygonJsonConverter());
            _jsonOptions.Converters.Add(new GeoJsonFeatureJsonConverter());
            _jsonOptions.Converters.Add(new GeoJsonFeatureCollectionJsonConverter());
            _jsonOptions.Converters.Add(new GeoJsonGeometryJsonConverter());
            _jsonOptions.Converters.Add(new Glossary200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new Glossary200ResponseGlossaryInnerJsonConverter());
            _jsonOptions.Converters.Add(new GridpointJsonConverter());
            _jsonOptions.Converters.Add(new Gridpoint12hForecastJsonConverter());
            _jsonOptions.Converters.Add(new Gridpoint12hForecastGeoJsonJsonConverter());
            _jsonOptions.Converters.Add(new Gridpoint12hForecastJsonLdJsonConverter());
            _jsonOptions.Converters.Add(new Gridpoint12hForecastPeriodJsonConverter());
            _jsonOptions.Converters.Add(new GridpointForecastUnitsJsonConverter());
            _jsonOptions.Converters.Add(new GridpointForecastUnitsNullableJsonConverter());
            _jsonOptions.Converters.Add(new GridpointGeoJsonJsonConverter());
            _jsonOptions.Converters.Add(new GridpointHazardsJsonConverter());
            _jsonOptions.Converters.Add(new GridpointHazardsValuesInnerJsonConverter());
            _jsonOptions.Converters.Add(new GridpointHazardsValuesInnerValueInnerJsonConverter());
            _jsonOptions.Converters.Add(new GridpointHourlyForecastJsonConverter());
            _jsonOptions.Converters.Add(new GridpointHourlyForecastGeoJsonJsonConverter());
            _jsonOptions.Converters.Add(new GridpointHourlyForecastJsonLdJsonConverter());
            _jsonOptions.Converters.Add(new GridpointHourlyForecastPeriodJsonConverter());
            _jsonOptions.Converters.Add(new GridpointHourlyForecastPeriodTemperatureJsonConverter());
            _jsonOptions.Converters.Add(new GridpointHourlyForecastPeriodWindGustJsonConverter());
            _jsonOptions.Converters.Add(new GridpointHourlyForecastPeriodWindSpeedJsonConverter());
            _jsonOptions.Converters.Add(new GridpointQuantitativeValueLayerJsonConverter());
            _jsonOptions.Converters.Add(new GridpointQuantitativeValueLayerValuesInnerJsonConverter());
            _jsonOptions.Converters.Add(new GridpointWeatherJsonConverter());
            _jsonOptions.Converters.Add(new GridpointWeatherValuesInnerJsonConverter());
            _jsonOptions.Converters.Add(new GridpointWeatherValuesInnerValueInnerJsonConverter());
            _jsonOptions.Converters.Add(new ISO8601IntervalJsonConverter());
            _jsonOptions.Converters.Add(new IconsSizeParameterJsonConverter());
            _jsonOptions.Converters.Add(new IconsSummary200ResponseJsonConverter());
            _jsonOptions.Converters.Add(new IconsSummary200ResponseIconsValueJsonConverter());
            _jsonOptions.Converters.Add(new JsonLdContextJsonConverter());
            _jsonOptions.Converters.Add(new LandRegionCodeJsonConverter());
            _jsonOptions.Converters.Add(new LandRegionCodeNullableJsonConverter());
            _jsonOptions.Converters.Add(new MarineAreaCodeJsonConverter());
            _jsonOptions.Converters.Add(new MarineAreaCodeNullableJsonConverter());
            _jsonOptions.Converters.Add(new MarineRegionCodeJsonConverter());
            _jsonOptions.Converters.Add(new MarineRegionCodeNullableJsonConverter());
            _jsonOptions.Converters.Add(new MetarPhenomenonJsonConverter());
            _jsonOptions.Converters.Add(new MetarSkyCoverageJsonConverter());
            _jsonOptions.Converters.Add(new MetarSkyCoverageNullableJsonConverter());
            _jsonOptions.Converters.Add(new NWSCenterWeatherServiceUnitIdJsonConverter());
            _jsonOptions.Converters.Add(new NWSCenterWeatherServiceUnitIdNullableJsonConverter());
            _jsonOptions.Converters.Add(new NWSForecastOfficeIdJsonConverter());
            _jsonOptions.Converters.Add(new NWSForecastOfficeIdNullableJsonConverter());
            _jsonOptions.Converters.Add(new NWSNationalHQIdJsonConverter());
            _jsonOptions.Converters.Add(new NWSNationalHQIdNullableJsonConverter());
            _jsonOptions.Converters.Add(new NWSOfficeIdJsonConverter());
            _jsonOptions.Converters.Add(new NWSOfficeIdNullableJsonConverter());
            _jsonOptions.Converters.Add(new NWSRegionalHQIdJsonConverter());
            _jsonOptions.Converters.Add(new NWSRegionalHQIdNullableJsonConverter());
            _jsonOptions.Converters.Add(new NWSZoneTypeJsonConverter());
            _jsonOptions.Converters.Add(new NWSZoneTypeNullableJsonConverter());
            _jsonOptions.Converters.Add(new ObservationJsonConverter());
            _jsonOptions.Converters.Add(new ObservationCloudLayersInnerJsonConverter());
            _jsonOptions.Converters.Add(new ObservationCollectionGeoJsonJsonConverter());
            _jsonOptions.Converters.Add(new ObservationCollectionGeoJsonAllOfFeaturesJsonConverter());
            _jsonOptions.Converters.Add(new ObservationCollectionJsonLdJsonConverter());
            _jsonOptions.Converters.Add(new ObservationGeoJsonJsonConverter());
            _jsonOptions.Converters.Add(new ObservationStationJsonConverter());
            _jsonOptions.Converters.Add(new ObservationStationCollectionGeoJsonJsonConverter());
            _jsonOptions.Converters.Add(new ObservationStationCollectionGeoJsonAllOfFeaturesJsonConverter());
            _jsonOptions.Converters.Add(new ObservationStationCollectionJsonLdJsonConverter());
            _jsonOptions.Converters.Add(new ObservationStationGeoJsonJsonConverter());
            _jsonOptions.Converters.Add(new ObservationStationJsonLdJsonConverter());
            _jsonOptions.Converters.Add(new OfficeJsonConverter());
            _jsonOptions.Converters.Add(new OfficeAddressJsonConverter());
            _jsonOptions.Converters.Add(new OfficeHeadlineJsonConverter());
            _jsonOptions.Converters.Add(new OfficeHeadlineCollectionJsonConverter());
            _jsonOptions.Converters.Add(new PaginationInfoJsonConverter());
            _jsonOptions.Converters.Add(new PointJsonConverter());
            _jsonOptions.Converters.Add(new PointGeoJsonJsonConverter());
            _jsonOptions.Converters.Add(new PointJsonLdJsonConverter());
            _jsonOptions.Converters.Add(new PointRelativeLocationJsonConverter());
            _jsonOptions.Converters.Add(new ProblemDetailJsonConverter());
            _jsonOptions.Converters.Add(new QuantitativeValueJsonConverter());
            _jsonOptions.Converters.Add(new RegionCodeJsonConverter());
            _jsonOptions.Converters.Add(new RegionCodeNullableJsonConverter());
            _jsonOptions.Converters.Add(new RelativeLocationJsonConverter());
            _jsonOptions.Converters.Add(new RelativeLocationGeoJsonJsonConverter());
            _jsonOptions.Converters.Add(new RelativeLocationJsonLdJsonConverter());
            _jsonOptions.Converters.Add(new SigmetJsonConverter());
            _jsonOptions.Converters.Add(new SigmetCollectionGeoJsonJsonConverter());
            _jsonOptions.Converters.Add(new SigmetGeoJsonJsonConverter());
            _jsonOptions.Converters.Add(new StateTerritoryCodeJsonConverter());
            _jsonOptions.Converters.Add(new StateTerritoryCodeNullableJsonConverter());
            _jsonOptions.Converters.Add(new TextProductJsonConverter());
            _jsonOptions.Converters.Add(new TextProductCollectionJsonConverter());
            _jsonOptions.Converters.Add(new TextProductLocationCollectionJsonConverter());
            _jsonOptions.Converters.Add(new TextProductTypeCollectionJsonConverter());
            _jsonOptions.Converters.Add(new TextProductTypeCollectionGraphInnerJsonConverter());
            _jsonOptions.Converters.Add(new ZoneJsonConverter());
            _jsonOptions.Converters.Add(new ZoneCollectionGeoJsonJsonConverter());
            _jsonOptions.Converters.Add(new ZoneCollectionGeoJsonAllOfFeaturesJsonConverter());
            _jsonOptions.Converters.Add(new ZoneCollectionJsonLdJsonConverter());
            _jsonOptions.Converters.Add(new ZoneForecastJsonConverter());
            _jsonOptions.Converters.Add(new ZoneForecastGeoJsonJsonConverter());
            _jsonOptions.Converters.Add(new ZoneForecastPeriodsInnerJsonConverter());
            _jsonOptions.Converters.Add(new ZoneGeoJsonJsonConverter());
            JsonSerializerOptionsProvider jsonSerializerOptionsProvider = new(_jsonOptions);
            _services.AddSingleton(jsonSerializerOptionsProvider);
            _services.AddSingleton<IApiFactory, ApiFactory>();
            _services.AddSingleton<DefaultApiEvents>();
        }

        /// <summary>
        /// Configures the HttpClients.
        /// </summary>
        /// <param name="client"></param>
        /// <param name="builder"></param>
        /// <returns></returns>
        public HostConfiguration AddApiHttpClients
        (
            Action<HttpClient>? client = null, Action<IHttpClientBuilder>? builder = null)
        {
            if (client == null)
                client = c => c.BaseAddress = new Uri(ClientUtils.BASE_ADDRESS);

            List<IHttpClientBuilder> builders = new List<IHttpClientBuilder>();

            builders.Add(_services.AddHttpClient<IDefaultApi, DefaultApi>(client));
            
            if (builder != null)
                foreach (IHttpClientBuilder instance in builders)
                    builder(instance);

            HttpClientsAdded = true;

            return this;
        }

        /// <summary>
        /// Configures the JsonSerializerSettings
        /// </summary>
        /// <param name="options"></param>
        /// <returns></returns>
        public HostConfiguration ConfigureJsonOptions(Action<JsonSerializerOptions> options)
        {
            options(_jsonOptions);

            return this;
        }

        /// <summary>
        /// Adds tokens to your IServiceCollection
        /// </summary>
        /// <typeparam name="TTokenBase"></typeparam>
        /// <param name="token"></param>
        /// <returns></returns>
        public HostConfiguration AddTokens<TTokenBase>(TTokenBase token) where TTokenBase : TokenBase
        {
            return AddTokens(new TTokenBase[]{ token });
        }

        /// <summary>
        /// Adds tokens to your IServiceCollection
        /// </summary>
        /// <typeparam name="TTokenBase"></typeparam>
        /// <param name="tokens"></param>
        /// <returns></returns>
        public HostConfiguration AddTokens<TTokenBase>(IEnumerable<TTokenBase> tokens) where TTokenBase : TokenBase
        {
            TokenContainer<TTokenBase> container = new TokenContainer<TTokenBase>(tokens);
            _services.AddSingleton(services => container);

            return this;
        }

        /// <summary>
        /// Adds a token provider to your IServiceCollection
        /// </summary>
        /// <typeparam name="TTokenProvider"></typeparam>
        /// <typeparam name="TTokenBase"></typeparam>
        /// <returns></returns>
        public HostConfiguration UseProvider<TTokenProvider, TTokenBase>() 
            where TTokenProvider : TokenProvider<TTokenBase>
            where TTokenBase : TokenBase
        {
            _services.AddSingleton<TTokenProvider>();
            _services.AddSingleton<TokenProvider<TTokenBase>>(services => services.GetRequiredService<TTokenProvider>());

            return this;
        }
    }
}
